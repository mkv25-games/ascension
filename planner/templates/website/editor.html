<html>

<head>
    <title>{{title}}</title>
    <style>
        html,
        body {
            background: #EEE;
            color: #333;
            font-family: sans-serif;
            padding: 20px;
        }
    </style>
    <link href="tiles.css" rel="stylesheet" />
    <script src="https://code.jquery.com/jquery-2.2.3.min.js" integrity="sha256-a23g1Nt4dtEYOj7bR+vTu7+T8VP13humZFBJNIYoEJo=" crossorigin="anonymous"></script>
    <script src="lib/tiles.js"></script>
    <script src="lib/layouts.js"></script>
</head>

<body>
    <h1>{{title}}</h1>
    <table class="tile grid preview bordered inline">
        <tbody>
            <tr>
                <td class="compass display tile tile-NW tile-{{NW}} primary">NW</td>
                <td class="compass display tile tile-NE tile-{{NE}} primary">NE</td>
            </tr>
            <tr>
                <td class="compass display tile tile-SW tile-{{SW}} primary">SW</td>
                <td class="compass display tile tile-SE tile-{{SE}} primary">SE</td>
            </tr>
        </tbody>
    </table>

    <div class="options bordered inline">
        <button id="micro-view">Micro View</button>
        <button id="mini-view">Mini View</button>
        <button id="macro-view">Macro View</button>
    </div>

    <div class="options bordered inline">
        <select id="layout-selection"></select>
    </div>

    <div class="options bordered inline" id="tile-selector"></div>

    <div class="tile area viewer bordered inline mini area contents"></div>

    <h2>Tile Data</h2>
    <pre id="tile-data" class="bordered"></pre>

    <p>Copy this data into the source.</p>

    <script>
        var compassMap = {
            NW: "{{NW}}",
            NE: "{{NE}}",
            SW: "{{SW}}",
            SE: "{{SE}}"
        };

        var dimensions = {
            width: Number.parseInt("{{areaViewer.dimensions.width}}"),
            height: Number.parseInt("{{areaViewer.dimensions.height}}")
        };

        var tileTypes = [1, 2, 3, 4, 5];
        var tileCompass = ['NW', 'NE', 'SW', 'SE'];
        var areaTiles = decodeTiles(layouts.default.tiles);
        var $cells = [];

        var isMouseDown = false;
        var paintValue = tileCompass[0];

        function setup() {

            setupTileCompass();
            setupTileSelector();
            setupAreaViewer();
            setupMouseInput();
            setupViewButtons();
            setupLayoutSelection();

            displayRawTileData();
        }

        function setupTileCompass() {
            $('.compass.tile').on('click', function() {
                var $compassTile = $(this);
                var compassKey = $compassTile.text();
                var newValue = (compassMap[compassKey] % tileTypes.length) + 1;
                changeCompassType(compassKey, newValue);
                $($compassTile).disableSelection();
            });
        }

        function setupTileSelector() {

            $tileSelector = $('#tile-selector');

            tileCompass.forEach(function(compassKey) {
                $tile = $(`<cell class="display tile selector tile-${compassKey} secondary">${compassKey}</cell>`);
                $tile.on('click', function() {
                    $tile = $(this);
                    $('.tile.selector').removeClass('selected').removeClass('primary').addClass('secondary');
                    $tile.addClass('selected').removeClass('secondary').addClass('primary');
                    var tileKey = $tile.text();
                    paintValue = tileKey;
                });
                $tileSelector.append($tile);
            });

            tiles.forEach(function(tile) {
                $tile = $(`<cell class="tile selector tile-${tile.id} secondary">${tile.symbol}</cell>`);
                $tile.on('click', function() {
                    $tile = $(this);
                    $('.tile.selector').removeClass('selected').removeClass('primary').addClass('secondary');
                    $tile.addClass('selected').removeClass('secondary').addClass('primary');
                    var tileKey = $tile.text();
                    paintValue = tileKey;
                });
                $tileSelector.append($tile);
            });
        }

        function changeCompassType(compassKey, value) {
            compassMap[compassKey] = value;
            removeColours();
            colourTiles();
        }

        function setupAreaViewer() {
            $table = $('div.area.contents');
            for (var j = 0; j < dimensions.height; j++) {
                $row = $('<row></row>');
                areaTiles[j] = areaTiles[j] || [];
                for (var i = 0; i < dimensions.width; i++) {
                    var fill = areaTiles[j][i];
                    $cell = $(`<cell class="display tile-${fill} primary">${fill}</cell>`);
                    $cell.on('mouseover', paintCell($cell, j, i));
                    $cell.update = updateCell($cell, j, i);
                    $row.append($cell);
                    $cells.push($cell);
                }
                $table.append($row);
            }
            $($table).disableSelection();
        }

        function setupMouseInput() {
            $('body').mousedown(function() {
                isMouseDown = true;
            }).mouseup(function() {
                isMouseDown = false;
                displayRawTileData();
            });
        }

        function setupViewButtons() {
            var $tileAreaViewer = $('.tile.area.viewer');

            $('button#macro-view').on('click', function() {
                $tileAreaViewer.removeClass('micro').removeClass('mini');
            });

            $('button#mini-view').on('click', function() {
                $tileAreaViewer.addClass('mini').removeClass('micro');
            });

            $('button#micro-view').on('click', function() {
                $tileAreaViewer.addClass('micro').removeClass('mini');
            });
        }

        function setupLayoutSelection() {
            $layoutSelection = $('select#layout-selection');
            Object.keys(layouts).forEach(function(key) {
                var layout = layouts[key];
                $option = $(`<option id="layout-${key}" value="${key}">${key}</option>`);
                $layoutSelection.append($option);
            });
            $layoutSelection.on('change', function() {
                var key = $layoutSelection.val();
                console.log('Change', key);
                showTileData(layouts[key].tiles);
            });
        }

        function showTileData(tileData) {
            areaTiles = decodeTiles(tileData);
            removeColours();

            $cells.forEach(function($cell) {
                $cell.update();
            });

            colourTiles();
        }

        function paintCell($cell, row, column) {
            return function(mouseEvent) {
                if (!isMouseDown) {
                    return false;
                }

                areaTiles[row][column] = paintValue;
                colourCell($cell, paintValue);
            }
        }

        function colourCell($cell, value) {
            var currentValue = $cell.text();
            $cell.removeClass('tile-' + compassMap[currentValue]);
            $cell.removeClass('tile-' + currentValue);

            $cell.addClass('tile-' + compassMap[value]);
            $cell.addClass('tile-' + value);
            $cell.text(value);
        }

        function updateCell($cell, row, column) {
            return function() {
                var value = areaTiles[row][column];
                colourCell($cell, value);
            };
        }

        function encodeTiles(areaTiles) {
            return areaTiles.map(function(row) {
                return row.join(':');
            });
        }

        function decodeTiles(areaTiles) {
            return areaTiles.map(function(row) {
                return row.split(':');
            });
        }

        function displayRawTileData() {
            var tileData = areaTiles.map(function(row) {
                return row.join(':');
            });
            var json = JSON.stringify(tileData, null, 2);
            $('#tile-data').text(json);
        }

        function removeColours() {
            tileTypes.forEach(function(i) {
                $('.display.tile-' + i).removeClass('tile-' + i);
            })
        }

        function colourTiles() {
            tileCompass.forEach(function(k) {
                $('.display.tile-' + k).addClass('tile-' + compassMap[k]);
            });
        }

        (function($) {
            $.fn.disableSelection = function() {
                return this
                    .attr('unselectable', 'on')
                    .css('user-select', 'none')
                    .on('selectstart', false);
            };
        })(jQuery);

        $(function() {
            setup();
            colourTiles();
        });
    </script>
</body>

</html>